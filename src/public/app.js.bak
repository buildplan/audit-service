document.getElementById("year").innerText = new Date().getFullYear();
let pollInterval;
let currentData = {}; 


async function startScan() {
    const domain = document.getElementById('domainInput').value.trim();
    if(!domain) return;

    // UI Reset
    document.getElementById('scanBtn').innerHTML = `<svg class="animate-spin h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
    document.getElementById('loadingSection').classList.remove('hidden');
    document.getElementById('resultsArea').classList.add('hidden');
    document.getElementById('errorMsg').classList.add('hidden');
    
    try {
        const res = await fetch('/api/scan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ domain })
        });
        
        const data = await res.json();
        if(data.error) throw new Error(data.error);

        currentData = data.tier1; // Store for modals
        renderTier1(data.tier1);
        
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('resultsArea').classList.remove('hidden');
        document.getElementById('scanBtn').innerText = 'Scan';
        
        // Set Up Deep Scan "Terminal"
        document.getElementById('deepScanStatus').innerText = 'Running...';
        document.getElementById('deepScanStatus').className = "px-2 py-1 rounded text-xs font-bold bg-blue-500/20 text-blue-400 border border-blue-500/20 animate-pulse";
        document.getElementById('tier2Loading').classList.remove('hidden');
        document.getElementById('tier2Results').classList.add('hidden');
        document.getElementById('screenshotContainer').classList.add('hidden');
        
        // Update screenshot link immediately
        document.getElementById('screenshotLink').href = `https://${domain}`;

        // Reset Terminal
        const terminal = document.getElementById('scanTerminal');
        terminal.innerHTML = `
            <div class="text-slate-500 mb-1">$ init wiredalter-scanner --deep --target=${domain}</div>
            <div class="text-blue-400 mb-1">> Spawning Headless Chrome... [OK]</div>
        `;

        pollDeepScan(data.id);

    } catch (err) {
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('errorMsg').innerText = err.message;
        document.getElementById('errorMsg').classList.remove('hidden');
        document.getElementById('scanBtn').innerText = 'Scan';
    }
}


function renderTier1(data) {
    // SSL
    const sslEl = document.getElementById('sslStatus');
    const sslDet = document.getElementById('sslDetail');
    if(data.ssl.valid) {
        sslEl.innerHTML = `<span class="text-emerald-400">Valid</span>`;
        sslDet.innerText = `Expires in ${data.ssl.daysRemaining} days`;
    } else {
        sslEl.innerHTML = `<span class="text-red-400">Invalid</span>`;
        sslDet.innerText = data.ssl.error || 'Certificate Error';
    }

    // Headers
    const gradeEl = document.getElementById('headerGrade');
    gradeEl.innerText = data.headers.grade;
    gradeEl.className = `text-4xl font-bold ${data.headers.grade === 'A' ? 'text-emerald-400' : (data.headers.grade === 'F' ? 'text-red-500' : 'text-yellow-400')}`;
    document.getElementById('headerServer').innerText = data.headers.server;

    // Ports
    const portsEl = document.getElementById('portsStatus');
    if(data.ports.open && data.ports.open.length > 0) {
        portsEl.innerHTML = `<span class="text-yellow-400">${data.ports.open.length} Ports Open</span>`;
    } else {
        portsEl.innerHTML = `<span class="text-emerald-400">All Common Closed</span>`;
    }

    // Carbon
    document.getElementById('carbonAmount').innerText = `${data.carbon.co2}g`;
    document.getElementById('carbonGreen').innerHTML = data.carbon.green ? 
        `<span class="text-emerald-400">ðŸŒ± Green Hosting</span>` : 
        `<span class="text-slate-500">Standard Hosting</span>`;
}


// Simulates a terminal output to make waiting less boring
function addTerminalLog(msg) {
    const terminal = document.getElementById('scanTerminal');
    terminal.innerHTML += `<div class="text-emerald-400 mb-1">> ${msg}</div>`;
    terminal.scrollTop = terminal.scrollHeight;
}


async function pollDeepScan(id) {
    let ticks = 0;
    clearInterval(pollInterval);
    
    pollInterval = setInterval(async () => {
        ticks++;
        // Add fake logs to keep it interesting
        if(ticks === 2) addTerminalLog("Analyzing Document Object Model (DOM)...");
        if(ticks === 4) addTerminalLog("Running Lighthouse Audits (Perf, SEO)...");
        if(ticks === 6) addTerminalLog("Fingerprinting Tech Stack (Wappalyzer)...");

        const res = await fetch(`/api/scan/${id}`);
        const job = await res.json();

        if (job.state === 'completed') {
            clearInterval(pollInterval);
            addTerminalLog("Analysis Complete. Rendering Report...");
            setTimeout(() => renderTier2(job.result), 500); // Small delay for effect
        } else if (job.state === 'failed') {
            clearInterval(pollInterval);
            document.getElementById('deepScanStatus').innerText = 'Failed';
            document.getElementById('deepScanStatus').className = "px-2 py-1 rounded text-xs font-bold bg-red-500/20 text-red-400 border border-red-500/20";
            document.getElementById('tier2Loading').innerHTML = `<span class="text-red-400">Scan Failed: ${job.error}</span>`;
        }
    }, 1000);
}


function renderTier2(data) {
    document.getElementById('deepScanStatus').innerText = 'Complete';
    document.getElementById('deepScanStatus').className = "px-2 py-1 rounded text-xs font-bold bg-emerald-500/20 text-emerald-400 border border-emerald-500/20";
    
    document.getElementById('tier2Loading').classList.add('hidden');
    document.getElementById('tier2Results').classList.remove('hidden');

    renderGauge('perfGauge', data.performance, document.getElementById('perfScore'));
    renderGauge('seoGauge', data.seo, document.getElementById('seoScore'));

    const techList = document.getElementById('techStackList');

    techList.innerHTML = '';
    if(data.tech && data.tech.length > 0) {
        data.tech.forEach(t => {
            const cssClass = t.isLegacy ? "bg-yellow-900/30 border-yellow-700/50 text-yellow-500" : "bg-slate-800 border-slate-700 text-slate-300";
            const tooltip = t.isLegacy ? "title='This technology was detected by ID only. Click for more info.'" : "";
            techList.innerHTML += `
                <span ${tooltip} onclick="${t.isLegacy ? "alert('This ID represents a proprietary technology or infrastructure detected by our 2025 signatures that does not yet have a public label in the legacy engine.')" : ""}" 
                    class="px-2 py-1 rounded-md border text-xs font-mono cursor-pointer ${cssClass}">
                    ${t.name}
                </span>`;
        });
    } else {
        techList.innerHTML = `<span class="text-slate-500 text-xs">No specific technologies detected.</span>`;
    }

    if(data.screenshot) {
        document.getElementById('screenshotContainer').classList.remove('hidden');
        document.getElementById('screenshotImg').src = data.screenshot;
    }
}


function renderGauge(elementId, score, textElement) {
    const color = score >= 90 ? '#34d399' : (score >= 50 ? '#fbbf24' : '#ef4444');
    const circumference = 2 * Math.PI * 45;
    const offset = circumference - (score / 100) * circumference;
    
    document.getElementById(elementId).innerHTML = `
        <svg viewBox="0 0 100 100" class="w-full h-full">
            <circle cx="50" cy="50" r="45" fill="none" stroke="#1e293b" stroke-width="8" />
            <circle cx="50" cy="50" r="45" fill="none" stroke="${color}" stroke-width="8" 
                    stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                    class="circle-chart__circle" stroke-linecap="round" />
        </svg>
    `;
    textElement.innerText = Math.round(score);
    textElement.style.color = color;
}


// --- MODAL LOGIC ---
function showModal(id) {
    const modal = document.getElementById(id);
    if(id === 'sslModal') {
        const d = currentData.ssl;
        document.getElementById('sslModalContent').innerHTML = `
            <div class="grid grid-cols-2 gap-2">
                <span class="text-slate-500">Status:</span> <span>${d.valid ? 'Valid' : 'Invalid'}</span>
                <span class="text-slate-500">Issuer:</span> <span>${d.issuer}</span>
                <span class="text-slate-500">Valid From:</span> <span>${d.validFrom ? new Date(d.validFrom).toLocaleDateString() : '-'}</span>
                <span class="text-slate-500">Expires:</span> <span>${d.validTo ? new Date(d.validTo).toLocaleDateString() : '-'}</span>
            </div>
        `;
    }
    if(id === 'headersModal') {
        const d = currentData.headers;
        let html = `<div class="mb-4 text-xs font-mono bg-slate-900 p-2 rounded">Server: ${d.server}</div>`;
        if(d.missing && d.missing.length > 0) {
            html += `<p class="text-red-400 text-xs font-bold mb-2">Missing Recommended Headers:</p>`;
            d.missing.forEach(m => html += `<div class="text-red-300 text-sm mb-1 flex items-center gap-2"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg> ${m}</div>`);
        } else {
            html += `<div class="text-emerald-400 text-sm flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> All core security headers are present!</div>`;
        }
        document.getElementById('headersModalContent').innerHTML = html;
    }
    if(id === 'portsModal') {
        const d = currentData.ports;
        let html = '';
        if(d.open && d.open.length > 0) {
            d.open.forEach(p => {
                html += `<div class="flex justify-between bg-slate-900 p-2 rounded mb-2 border border-red-900/30">
                    <span class="text-white font-mono">Port ${p}</span>
                    <span class="text-red-400 text-xs uppercase font-bold">Open</span>
                </div>`;
            });
        } else {
            html = `<div class="text-emerald-400 text-sm">No common ports found open (21, 22, 80, 443, 8080). This is good for security (stealth).</div>`;
        }
        document.getElementById('portsModalContent').innerHTML = html;
    }
    modal.showModal();
}


function closeModal(id) { document.getElementById(id).close(); }
document.querySelectorAll('dialog').forEach(dialog => {
    dialog.addEventListener('click', (event) => {
        if (event.target === dialog) dialog.close();
    });
});
